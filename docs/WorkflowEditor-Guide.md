# Workflow Editor ガイド

## 概要

Workflow Editorは、`workflow.json`設定ファイルを視覚的に編集できるGUIツールです。Windows Formsを使用して、ワークフローの基本設定とステップの詳細設定を直感的に編集できます。

## 機能

### 基本設定タブ
- **ワークフロー名**: ワークフローの表示名を設定
- **バージョン**: ワークフローのバージョン番号を管理
- **説明**: ワークフローの説明文を記載
- **設定**: 以下の実行設定を管理
  - 最大リトライ回数（0-10回）
  - リトライ遅延（0-300秒）
  - ログレベル（DEBUG/INFO/WARN/ERROR）
  - 再起動有効化
  - 完了時クリーンアップ

### ステップ設定タブ
- **ステップ一覧表示**: 
  - ナンバリング表示（実行順序）
  - ステップID、名前、説明、スクリプトパス
  - タイプ、管理者権限、再起動必須の状態表示
- **ステップ管理**:
  - 「新規追加」: 新しいステップを作成して一覧の最後に追加
  - 「削除」: 選択したステップを削除（確認ダイアログ付き）
- **ステップ順序変更**:
  - 「上へ移動」「下へ移動」ボタンで実行順序を調整
  - 移動後も選択状態を維持
- **ステップ詳細編集**:
  - ステップID（読み取り専用、新規追加時は入力ダイアログで指定）
  - ステップ名と説明
  - スクリプトパス
  - タイプ選択（powershell/batch/internal）
  - 実行オプション（管理者権限、再起動必須）
  - タイムアウト設定（0-7200秒）
  - リトライ回数（0-10回）
  - エラー時の動作（stop/continue/retry）
  - **依存関係設定**: 他のステップへの依存を複数選択で設定
    - CheckListBoxで複数のステップを選択可能
    - 自分自身への依存は表示されない（循環依存防止）
    - 依存するステップが完了してから実行される

## 使用方法

### 起動方法

#### 推奨方法：batファイルを使用
```batch
# 既定の設定ファイルで起動
workflow-editor.bat

# カスタム設定ファイルを指定
workflow-editor.bat "path\to\custom\workflow.json"
```

#### 直接PowerShellを使用
```powershell
# 既定の設定ファイルで起動
.\WorkflowEditor.ps1

# カスタム設定ファイルを指定
.\WorkflowEditor.ps1 -ConfigPath "path\to\custom\workflow.json"
```

**注意**: PowerShellを直接実行する場合は、実行ポリシーを事前に設定する必要があります。batファイルを使用すると、これらの設定が自動的に処理されます。

![image](https://github.com/user-attachments/assets/23f9a98f-3f0f-406c-ad1a-10475c7911c4)

![image](https://github.com/user-attachments/assets/22f9c61c-55cc-4583-a1e4-a2883dc6cab0)

### 基本操作

1. **ファイル操作**
   - `Ctrl+O`: 設定ファイルを開く
   - `Ctrl+S`: 現在のファイルに保存
   - メニューまたはボタンから「名前を付けて保存」

2. **基本設定の編集**
   - 基本設定タブで各項目を編集
   - 「基本設定を適用」ボタンで変更を適用
   - 「保存」ボタンでファイルに保存

3. **ステップの編集**
   - ステップ設定タブでステップ一覧を確認
   - ステップを選択すると詳細が下部に表示
   - 詳細を編集後「ステップ設定を適用」ボタンで変更を適用
   - **依存関係設定**: 
     - 「依存関係設定」セクションで他のステップへの依存を設定
     - 複数のステップにチェックを入れて依存関係を定義
     - 依存するステップがすべて完了してから実行される

4. **ステップの管理**
   - **新規追加**: 「新規追加」ボタンでデフォルト設定の新しいステップを作成
     - ステップID入力ダイアログが表示されます
     - 半角英数字とハイフンのみ使用可能
     - 既存IDとの重複は自動チェック
     - 「自動提案」ボタンで推奨IDを設定可能
   - **削除**: ステップを選択して「削除」ボタンで削除（確認ダイアログが表示）
   - **ID自動生成**: 「自動提案」ボタンで「step1」「step2」...の形式で推奨IDを提案

5. **ステップ順序の変更**
   - ステップを選択
   - 「上へ移動」「下へ移動」ボタンで順序を調整
   - 変更は即座に反映され、選択状態が維持される

### 保存機能

- **保存**: 現在開いているファイルに上書き保存
- **名前を付けて保存**: 新しいファイル名で保存
- **自動バックアップ**: JSONファイルはUTF-8（BOMなし）で保存
- **インデント**: 2スペースインデントで読みやすい形式

## 技術仕様

### 対応環境
- Windows 10/11
- PowerShell 5.1以上
- .NET Framework（Windows Forms）

### ファイル形式
- 入力: JSON形式のワークフロー設定ファイル
- 出力: UTF-8（BOMなし）エンコーディングのJSONファイル
- インデント: 2スペース
- **dependsOn配列**: ステップ間の依存関係を文字列配列で保存
- **循環依存チェック**: UI層で自分自身への依存を防止

### UI設計
- **分割パネル**: 上下分割で一覧と詳細を同時表示
- **リサイズ対応**: ウィンドウサイズに応じてコントロールが自動調整
- **フォーカス管理**: ステップ移動後も選択状態を維持
- **バリデーション**: 数値項目の範囲チェック
- **ステップ管理**: ツールバー形式のボタン配置で直感的操作
- **確認ダイアログ**: 削除操作時の安全性確保
- **入力ダイアログ**: ステップID入力時のリアルタイムバリデーション
- **自動提案機能**: 適切なデフォルトIDの提案
- **依存関係設定**: CheckListBoxによる複数選択で直感的な依存関係定義
- **循環依存防止**: 自分自身への依存を除外した選択肢表示

## トラブルシューティング

### よくある問題

1. **設定ファイルが見つからない**
   ```
   エラー: 設定ファイルが見つかりません。
   ```
   - 解決方法: `-ConfigPath`パラメータで正しいパスを指定

2. **JSON形式エラー**
   ```
   Failed to load configuration file: ...
   ```
   - 解決方法: JSONファイルの構文を確認、または新しいファイルを作成

3. **フォーム表示エラー**
   ```
   エラー: フォームの作成に失敗しました。
   ```
   - 解決方法: PowerShell 5.1以上とWindows Formsが利用可能か確認

4. **ステップ追加エラー**
   ```
   設定ファイルが読み込まれていません。
   ```
   - 解決方法: 先に有効な設定ファイルを開いてから操作を実行

5. **ステップID形式エラー**
   ```
   ステップIDは半角英数字とハイフンのみ使用できます。
   ```
   - 解決方法: 使用可能文字（a-z、A-Z、0-9、ハイフン）のみでIDを入力

6. **ステップID重複エラー**
   ```
   このステップIDは既に存在します。別のIDを入力してください。
   ```
   - 解決方法: 既存のステップと異なるIDを入力、または「自動提案」ボタンを使用

7. **ステップID重複**
   - 新規ステップのID生成で既存IDと重複した場合
   - 解決方法: 自動生成機能が重複を回避（通常は発生しない）

### デバッグ情報

起動時に以下の情報がコンソールに表示されます：
- 設定ファイルの読み込み状況
- フォーム作成状況
- 初期データ読み込み状況

## 注意事項

- **管理者権限**: ファイル保存時に管理者権限が必要な場合があります
- **バックアップ**: 重要な設定ファイルは事前にバックアップを取ってください
- **文字エンコーディング**: UTF-8（BOMなし）で保存されるため、他のエディタとの互換性があります
- **ステップ削除**: 削除操作は元に戻せません。重要なステップは削除前に設定をメモしてください
- **デフォルト値**: 新規ステップには標準的なデフォルト値が設定されますが、実際の環境に合わせて編集してください

## 関連ドキュメント

- [ワークフロー設定ガイド](Customization-Guide.md): workflow.jsonの詳細仕様
- [アプリケーション管理ガイド](Application-Management.md): applications.jsonの編集方法
- [トラブルシューティング](Troubleshooting.md): 一般的な問題解決方法
